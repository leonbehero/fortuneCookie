Private GameTimer As clsTimer
Dim Citizen As clsCitizen
'Dim City As clsCity
Dim Hospital As clsHospital
'Private GameSheet As clsGameSheet

Public Sub InitialiseGame()

'Application.ScreenUpdating = False

    'Set City = New clsCity
    Set Citizen = New clsCitizen
    Set Hospital = New clsHospital
    
    'Citizen.DrawPerson
    DayCount = 1
    PatientNumber = 0
    HealthyNumber = CityPopulation - InfectionNumber
    shData.Range("a2:c500").Value = ""
    shData.Range("a" & DayCount + 1).Value = DayCount
    shData.Range("b" & DayCount + 1).Value = InfectionNumber + 1
    shData.Range("c" & DayCount + 1).Value = InfectionNumber + 1
    shCity.Shapes("DayNumber").TextFrame2.TextRange.Characters.Text = DayCount
    shCity.Shapes("HealthyNumber").TextFrame2.TextRange.Characters.Text = HealthyNumber + 1
    shCity.Shapes("InfectionNumber").TextFrame2.TextRange.Characters.Text = InfectionNumber + 1 - RecoveredPatient
    shCity.Shapes("NumberinHospital").TextFrame2.TextRange.Characters.Text = PatientNumber
    shCity.Shapes("NumberofBeds").TextFrame2.TextRange.Characters.Text = TotalBeds
    shCity.Shapes("ExposureNumber").TextFrame2.TextRange.Characters.Text = ExposedNumber
    SetGameKeys
                                                                    
    Set GameTimer = New clsTimer
    
    GameTimer.StartTimer

End Sub
Public Sub resetGame()
    Set GameTimer = Nothing
    Set Citizen = Nothing
    Set Hospital = Nothing
    shData.Range("a2:c500").Value = ""
    shCity.Shapes("DayNumber").TextFrame2.TextRange.Characters.Text = 0
    shCity.Shapes("HealthyNumber").TextFrame2.TextRange.Characters.Text = CityPopulation + 1
    shCity.Shapes("InfectionNumber").TextFrame2.TextRange.Characters.Text = 0
    shCity.Shapes("NumberinHospital").TextFrame2.TextRange.Characters.Text = 0
    shCity.Shapes("NumberofBeds").TextFrame2.TextRange.Characters.Text = 0
    shCity.Shapes("ExposureNumber").TextFrame2.TextRange.Characters.Text = 0
    shCity.Range("E195:to705").ClearFormats
    Set Citizen = Nothing
    Set Hospital = Nothing
    
    
End Sub

Public Sub PauseGame()
    Set GameTimer = Nothing
End Sub
Public Sub ResumeGame()
    Set GameTimer = New clsTimer
    
    GameTimer.StartTimer
End Sub
Public Sub TerminateGame()

    'Called once when game ends
    
    'Used to tidy up
    
    Set GameTimer = Nothing
    
    Set Citizen = Nothing
    Set Hospital = Nothing
    
    'shMenu.Activate
    
    'Set GameSheet = Nothing
    
    ResetKeys

End Sub
Public Sub updateanddraw()
        Citizen.update
        Citizen.CalculateInfection
        'Citizen.DrawPerson
        shCity.Shapes("DayNumber").TextFrame2.TextRange.Characters.Text = DayCount
End Sub
Public Sub UpdateAndDrawGame()

    'Called by the SetTimer function
    
    'Runs once for each tick of the timer clock
    
    'Updates all game logic
    
    'Draws all game objects
    'Debug.Print GetAsyncKeyState(vbKeyTab)
    TimerCount = TimerCount + 1
    
    If GetAsyncKeyState(vbKeyTab) <> 0 Then
    
        TerminateGame
        
        Exit Sub
    
    End If
    'Debug.Print TimerCount
    If TimerCount Mod 2 = 0 Then
        'DayCount = DayCount + 1
        Citizen.update
        Citizen.CalculateInfection
        'Citizen.DrawPerson
        shCity.Shapes("InfectionNumber").TextFrame2.TextRange.Characters.Text = InfectionNumber + 1 - RecoveredPatient
        HealthyNumber = CityPopulation - InfectionNumber
        shCity.Shapes("HealthyNumber").TextFrame2.TextRange.Characters.Text = HealthyNumber + 1
        shCity.Shapes("ExposureNumber").TextFrame2.TextRange.Characters.Text = ExposedNumber
        updateBarCharts
    End If
    
    If TimerCount Mod 4 = 0 Then
        DayCount = DayCount + 1
        shCity.Shapes("DayNumber").TextFrame2.TextRange.Characters.Text = DayCount
        Hospital.update
        Hospital.updatePatient
        shCity.Shapes("NumberinHospital").TextFrame2.TextRange.Characters.Text = PatientNumber
        shCity.Shapes("NumberofBeds").TextFrame2.TextRange.Characters.Text = TotalBeds
        shCity.Shapes("InfectionNumber").TextFrame2.TextRange.Characters.Text = InfectionNumber + 1 - RecoveredPatient
        shCity.Shapes("NumberofRecovered").TextFrame2.TextRange.Characters.Text = RecoveredPatient
        shData.Range("a" & DayCount + 1).Value = DayCount
        shData.Range("c" & DayCount + 1).Value = InfectionNumber + 1 - RecoveredPatient
        shData.Range("b" & DayCount + 1).Value = InfectionNumber - shData.Range("c" & DayCount).Value + 1
        
        If DayCount Mod 7 = 0 Then
            PauseGame
        End If
    End If
    
    'If TimerCount Mod 10 = 0 Then
    '    shCity.Shapes(1).TextFrame2.TextRange.Characters.Text = DayCount
    'End If
    'If TimerCount Mod 20 = 0 Then
    '    DayCount = DayCount + 1
    '    shCity.Shapes(1).TextFrame2.TextRange.Characters.Text = DayCount
    'End If

End Sub
Sub updateBarCharts()
    Dim barLength As Integer
    Dim Percentage As Single
    
    Percentage = InfectionNumber / CityPopulation
    shCity.Shapes("InfectionBar2").Width = CInt(Percentage * shCity.Shapes("InfectionBar1").Width)
    'shCity.Shapes("InfectionBar1").Width = 400
    'Debug.Print shCity.Shapes("InfectionBar1").Width
End Sub
Sub updatebar()
    shCity.Shapes("InfectionBar1").Width = 600
    
End Sub
Sub getcolor()
    
    Debug.Print Range("a5").Interior.ColorIndex
    
End Sub
Sub testtextframe()
'shCity.ShapeRange(1).TextFrame2.TextRange.Characters.Text = "Infection Number:"
Debug.Print shCity.Shapes(1).Name

shCity.Shapes(1).TextFrame2.TextRange.Characters.Text = "Infection Number:"

End Sub

Private Sub SetGameKeys()

    Application.OnKey "{ESC}", ""
    
    Application.OnKey "{UP}", "upkey"
    
    Application.OnKey "{DOWN}", "downkey"
    
    Application.OnKey "{LEFT}", "leftkey"
    
    Application.OnKey "{RIGHT}", "rightkey"
    
    Application.OnKey "{TAB}", ""

End Sub

Private Sub ResetKeys()

    Application.OnKey "{UP}"
    
    Application.OnKey "{DOWN}"
    
    Application.OnKey "{TAB}"
    
    Application.OnKey "{ESC}"
    
    Application.OnKey "{LEFT}"
    
    Application.OnKey "{RIGHT}"

End Sub

Sub testingrandom()
    Dim x As Integer
    x = Int((5 - 0 - 1) * Rnd + 1)
    Debug.Print x
    
End Sub


Public Sub Pause(sngSecs As Single)
    Dim sngEnd As Single
    sngEnd = Timer + sngSecs
    While Timer < sngEnd
        DoEvents
    Wend
End Sub
Sub WasteTime(Finish As Long)
 
    Dim NowTick As Long
    Dim EndTick As Long
 
    EndTick = GetTickCount + (Finish)
     
    Do
 
        NowTick = GetTickCount
        DoEvents
 
    Loop Until NowTick >= EndTick
 
End Sub

Private Sub DelayMs(ms As Long)
    Debug.Print TimeValue(Now)
    Application.Wait (Now + (ms * 0.00000001))
    Debug.Print TimeValue(Now)
End Sub

Public Sub TestPause()
    Call DelayMs(500)
    MsgBox "done"
End Sub

Sub StartTimer()
    
    TimerActive = True
    'Debug.Print TimerActive
    
End Sub

Private Sub Start_Timer()
    TimerActive = True
    Debug.Print "yes", timeactive
    Application.OnTime Now() + TimeValue("00:00:01"), "moveSnake"
End Sub

Private Sub Stop_Timer()
    TimerActive = False
    Debug.Print TimerActive
End Sub

Private Sub Timers()
    If TimerActive Then
        ActiveSheet.Cells(1, 1).Value = Time
        Application.OnTime Now() + TimeValue("00:00:01"), "Timer"
    End If
End Sub


Sub testrandom()
    Dim x As Double
    x = Int(Abs(RandNorm(0, 1) * 28))
    Debug.Print x
    
End Sub

